name: sypy Release

on:
    push:
        tags:
            - "sypy-v*"
    workflow_dispatch:
        inputs:
            dry_run:
                description: "Build only, don't publish"
                required: false
                type: boolean
                default: false

permissions:
    contents: read

jobs:
    # Native x86_64 Linux build - uses system OpenSSL
    linux-x86_64:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: x86_64
                  args: --release --out dist --find-interpreter --manifest-path sypy/Cargo.toml
                  sccache: "true"
                  manylinux: "2_28"
                  # Native build: use system OpenSSL (faster, no Perl needed)
                  before-script-linux: |
                      dnf install -y openssl-devel pkg-config
                      # Use system OpenSSL instead of vendored
                      mkdir -p /home/runner/work/sy/sy/.cargo
                      echo '[env]' > /home/runner/work/sy/sy/.cargo/config.toml
                      echo 'OPENSSL_NO_VENDOR = "1"' >> /home/runner/work/sy/sy/.cargo/config.toml
            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-linux-x86_64
                  path: dist

    # Cross-compile aarch64 Linux build - uses vendored OpenSSL
    # Cross containers don't have target-arch OpenSSL headers, so we must vendor
    linux-aarch64:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: aarch64
                  args: --release --out dist --find-interpreter --manifest-path sypy/Cargo.toml
                  sccache: "true"
                  manylinux: "2_28"
                  # Cross-compile: must use vendored OpenSSL (no cross-compiled headers available)
                  # Install all Perl modules needed to build OpenSSL from source
                  # See: https://docs.rs/openssl/latest/openssl/#vendored
                  before-script-linux: |
                      apt-get update
                      # Install full Perl with all modules needed by OpenSSL's build system
                      apt-get install -y perl perl-modules pkg-config make
            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-linux-aarch64
                  path: dist

    # Windows disabled - requires additional platform-specific work
    # TODO: Fix Windows build (unix-specific code in handler.rs, missing Win32 API)
    # windows:
    #     runs-on: windows-latest
    #     strategy:
    #         matrix:
    #             target: [x64]
    #     steps:
    #         - uses: actions/checkout@v4
    #         - name: Build wheels
    #           uses: PyO3/maturin-action@v1
    #           with:
    #               target: ${{ matrix.target }}
    #               args: --release --out dist --find-interpreter --manifest-path sypy/Cargo.toml
    #               sccache: "true"
    #         - name: Upload wheels
    #           uses: actions/upload-artifact@v4
    #           with:
    #               name: wheels-windows-${{ matrix.target }}
    #               path: dist

    macos:
        runs-on: macos-latest
        strategy:
            matrix:
                target: [x86_64, aarch64]
        steps:
            - uses: actions/checkout@v4
            - name: Build wheels
              uses: PyO3/maturin-action@v1
              with:
                  target: ${{ matrix.target }}
                  args: --release --out dist --find-interpreter --manifest-path sypy/Cargo.toml
                  sccache: "true"
            - name: Upload wheels
              uses: actions/upload-artifact@v4
              with:
                  name: wheels-macos-${{ matrix.target }}
                  path: dist

    sdist:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
            - name: Build sdist
              uses: PyO3/maturin-action@v1
              with:
                  command: sdist
                  args: --out dist --manifest-path sypy/Cargo.toml
            - name: Upload sdist
              uses: actions/upload-artifact@v4
              with:
                  name: sdist
                  path: dist

    release:
        name: Release
        runs-on: ubuntu-latest
        if: "startsWith(github.ref, 'refs/tags/sypy-v') && !inputs.dry_run"
        needs: [linux-x86_64, linux-aarch64, macos, sdist]
        permissions:
            id-token: write
        environment:
            name: pypi
            url: https://pypi.org/p/sy-python
        steps:
            - uses: actions/download-artifact@v4
              with:
                  merge-multiple: true
                  path: dist
            - name: Publish to PyPI
              uses: pypa/gh-action-pypi-publish@release/v1
              with:
                  packages-dir: dist
                  skip-existing: true
